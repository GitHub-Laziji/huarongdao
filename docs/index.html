<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>huarongdao</title>
    <link rel="stylesheet" href="./lib/element-plus@2.9.11/index.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div id="app" style="min-width: 100vw;min-height: 100vh;display: flex;justify-content: center;align-items: center;">
        <div style="box-shadow: var(--el-box-shadow);padding: 20px;border-radius: 4px;">
            <div style="display: flex;justify-content: center;font-size: 30px;font-weight: 600;">数字华容道</div>
            <div style="margin-top: 20px;display: flex;">
                <el-select v-model="size" placeholder="难度" style="width: 100%;" @change="v=>selectSize(v,v)">
                    <el-option v-for="item in sizes" :key="item" :label="item+'X'+item" :value="item" />
                </el-select>
                <el-button style="margin-left: 10px;" @click="auto()">自动完成</el-button>
            </div>
            <div style="display: flex;flex-direction: column;border: 1px solid #555;margin-top: 20px;">
                <div v-for="(row,y) of map" style="display: flex;">
                    <div v-for="(col,x) of row" @click="step(x,y)"
                        style="width: 80px;height: 80px;border: 1px solid #555;">
                        <div style="display: flex;justify-content: center;align-items: center;width: 100%;height: 100%;background: #E6A23C;font-size: 20px;font-weight: 600;"
                            v-if="col>0">
                            {{col}}
                        </div>
                        <div style="display: flex;justify-content: center;align-items: center;width: 100%;height: 100%;background: #E4E7ED;"
                            v-else>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="./lib/vue@3.2.47.global.min.js"></script>
    <script src="./lib/element-plus@2.9.11/index.js"></script>
    <script>
        const app = Vue.createApp({
            data() {
                return {
                    w: 0,
                    h: 0,
                    map: [],
                    size: 5,
                    sizes: [],
                    startTime: 0
                }
            },
            mounted() {
                this.sizes = [];
                for (let i = 3; i <= 10; i++) {
                    this.sizes.push(i);
                }
                this.selectSize(this.size, this.size);
            },
            methods: {
                selectSize(w, h) {
                    this.w = w;
                    this.h = h;
                    this.genMap();
                },
                genMap() {
                    this.startTime = new Date().getTime();
                    let arr = [];
                    for (let i = 1; i <= this.w * this.h - 1; i++) {
                        arr.push({ v: i, w: Math.random() });
                    }
                    arr.sort((a, b) => a.w - b.w);
                    let rn = 0;
                    for (let i = 0; i < arr.length; i++) {
                        for (let j = i + 1; j < arr.length; j++) {
                            if (arr[j].v > arr[i].v) {
                                rn++;
                            }
                        }
                    }
                    rn += this.w - 1;
                    arr.push({ v: 0 });
                    this.map = [];
                    for (let i = 0; i < arr.length; i++) {
                        if (i % this.w == 0) {
                            this.map.push([]);
                        }
                        let v = arr[i].v;
                        if (rn % 2 === 1) {
                            console.log("==")
                            v = v == 1 ? 2 : v == 2 ? 1 : v;
                        }
                        this.map[this.map.length - 1].push(v);
                    }
                },
                step(x, y) {
                    let t = this.map[y][x];
                    if (x - 1 >= 0 && this.map[y][x - 1] === 0) {
                        this.map[y][x - 1] = t;
                    } else if (x + 1 < this.w && this.map[y][x + 1] === 0) {
                        this.map[y][x + 1] = t;
                    } else if (y - 1 >= 0 && this.map[y - 1][x] === 0) {
                        this.map[y - 1][x] = t;
                    } else if (y + 1 < this.h && this.map[y + 1][x] === 0) {
                        this.map[y + 1][x] = t;
                    } else {
                        return;
                    }
                    this.map[y][x] = 0;
                    this.win();
                },
                win() {
                    for (let i = 0; i < this.w * this.h - 1; i++) {
                        if (this.map[Math.floor(i / this.w)][i % this.w] != i + 1) {
                            return;
                        }
                    }
                    setTimeout(() => {
                        let dd = new Date().getTime() - this.startTime;
                        alert(`恭喜你完成 ${this.w}X${this.h} 难度的游戏！耗时：${Math.floor(dd / 1000)}秒`);
                        this.genMap();
                    });
                },
                auto() {
                    let tMap = JSON.parse(JSON.stringify(this.map));
                    let forbidMap = JSON.parse(JSON.stringify(this.map));
                    console.log(tMap, forbidMap)
                    for (let y = 0; y < this.h; y++) {
                        for (let x = 0; x < this.w; x++) {
                            forbidMap[y][x] = 0;
                        }
                    }
                    let stepList = [];
                    const find = (num) => {
                        for (let y = 0; y < this.h; y++) {
                            for (let x = 0; x < this.w; x++) {
                                if (tMap[y][x] == num) {
                                    return { x, y };
                                }
                            }
                        }
                    }
                    let init0 = find(0);
                    const pass = (x, y) => {
                        return x >= 0 && x < this.w && y >= 0 && y < this.h && forbidMap[y][x] != 1;
                    }
                    const passList = (x, y) => {
                        let list = [];
                        if (pass(x, y + 1)) {
                            list.push({ x: x, y: y + 1 });
                        }
                        if (pass(x, y - 1)) {
                            list.push({ x: x, y: y - 1 });
                        }
                        if (pass(x + 1, y)) {
                            list.push({ x: x + 1, y: y });
                        }
                        if (pass(x - 1, y)) {
                            list.push({ x: x - 1, y: y });
                        }
                        return list;
                    }
                    const bfs = (x1, y1, x2, y2) => {
                        console.log("bfs======================")
                        console.log(x1, y1, x2, y2)
                        console.log("forbidMap", JSON.stringify(forbidMap))
                        let dp = {};
                        let queue = [{ x: x1, y: y1, n: 0 }];
                        while (queue.length) {
                            // console.log(JSON.stringify(queue), JSON.stringify(dp))
                            let { x, y, n } = queue.shift();
                            if (dp[`${x},${y}`] != undefined) {
                                continue;
                            }
                            dp[`${x},${y}`] = n;
                            for (let next of passList(x, y)) {
                                queue.push({ n: n + 1, ...next });
                            }
                        }
                        console.log("dp", JSON.stringify(dp))
                        let shortPath = [];
                        let x = x2, y = y2;
                        while (true) {
                            // console.log(x, y, dp[`${x},${y}`])
                            shortPath.unshift({ x, y });
                            if (x == x1 && y == y1) {
                                break;
                            }
                            for (let next of passList(x, y)) {
                                if (dp[`${next.x},${next.y}`] == dp[`${x},${y}`] - 1) {
                                    x = next.x;
                                    y = next.y;
                                    break;
                                }
                            }
                        }

                        console.log("shortPath", JSON.stringify(shortPath))
                        console.log("bfs======================end")
                        return shortPath;
                    }

                    const moveSp = (x, y) => {
                        let spXy = find(0);
                        let spSp = bfs(spXy.x, spXy.y, x, y);
                        for (let spi = 1; spi < spSp.length; spi++) {
                            tMap[spSp[spi - 1].y][spSp[spi - 1].x] = tMap[spSp[spi].y][spSp[spi].x]
                            tMap[spSp[spi].y][spSp[spi].x] = 0;
                            stepList.push(spSp[spi]);
                        }
                    }
                    const moveNum = (num, x, y) => {
                        let iXy = find(num);
                        let tXy = { x, y };
                        let shortPath = bfs(iXy.x, iXy.y, tXy.x, tXy.y);
                        for (let s = 1; s < shortPath.length; s++) {
                            forbidMap[shortPath[s - 1].y][shortPath[s - 1].x] = 1;
                            moveSp(shortPath[s].x, shortPath[s].y);
                            forbidMap[shortPath[s - 1].y][shortPath[s - 1].x] = 0;
                            tMap[shortPath[s].y][shortPath[s].x] = tMap[shortPath[s - 1].y][shortPath[s - 1].x];
                            tMap[shortPath[s - 1].y][shortPath[s - 1].x] = 0;
                            stepList.push(shortPath[s - 1]);
                        }
                    }

                    for (let y = 0; y < this.h; y++) {
                        if (this.h - y > 2) {
                            let startNum = this.w * y + 1;
                            let endNum1 = startNum + this.w - 2;
                            let endNum2 = endNum1 + 1;
                            for (let i = startNum; i < endNum2; i++) {
                                let tX = (i - 1) % this.w, tY = Math.floor((i - 1) / this.h);
                                moveNum(i, tX, tY);
                                forbidMap[tY][tX] = 1;
                            }

                            let tX = (endNum2 - 1) % this.w, tY = Math.floor((endNum2 - 1) / this.h);
                            if (tMap[tY][tX] != endNum2) {
                                moveNum(endNum2, tX, tY + 2);
                                forbidMap[tY + 2][tX] = 1;
                                forbidMap[tY][tX - 1] = 0;
                                moveNum(endNum1, tX, tY + 1);
                                forbidMap[tY + 1][tX] = 1;
                                moveSp(tX, tY);

                                forbidMap[tY + 2][tX] = 0;
                                forbidMap[tY + 1][tX] = 0;
                                moveSp(tX, tY + 1);
                                moveSp(tX, tY + 2);
                                moveSp(tX - 1, tY + 2);
                                moveSp(tX - 1, tY + 1);
                                moveSp(tX - 1, tY + 0);
                                moveSp(tX, tY);
                                moveSp(tX, tY + 1);
                            }
                            forbidMap[tY][tX - 1] = 1;
                            forbidMap[tY][tX] = 1;
                        }
                    }
                    console.log(stepList)
                    const run = (xy, i) => {
                        if (i >= stepList.length) {
                            return;
                        }
                        this.map[xy.y][xy.x] = this.map[stepList[i].y][stepList[i].x]
                        this.map[stepList[i].y][stepList[i].x] = 0;
                        setTimeout(() => {
                            run(stepList[i], i + 1);
                        }, 200)
                    }
                    run(init0, 0);
                }
            }
        });
        app.use(ElementPlus);
        app.mount("#app");
    </script>
</body>

</html>